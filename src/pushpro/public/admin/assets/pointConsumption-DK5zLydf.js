
/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * https://fantastic-admin.github.io
 */

import{_ as ye}from"./index.vue_vue_type_script_setup_true_lang-BkBSJsBX.js";import{V,d as be,r as h,m as F,a as xe,p as _,q as we,g as I,c as B,b as l,w as n,e as r,h as y,z as ke,v as S,t as v,i as q,F as ee,s as te,N as ae,G as c,j as he,_ as Ie,W as Re,X as Ve,l as Ne,k as le}from"./index-CnisIzlN.js";import{a as oe}from"./config-l0iHqPQb.js";import{A as Ce}from"./package-BI-PCw_U.js";import{d as P}from"./index-BE-LteFu.js";function $e(){return V({url:"/point-consumption-rule/list",method:"get"})}function Ae(p){return V({url:`/point-consumption-rule/${p}`,method:"get"})}function De(p){return V({url:"/point-consumption-rule",method:"post",data:p})}function Fe(p,f){return console.log("API updateRule 请求数据:",JSON.stringify({id:p,data:f})),V({url:`/point-consumption-rule/${p}`,method:"put",data:f})}function Te(p){return V({url:`/point-consumption-rule/${p}`,method:"delete"})}function Me(p,f){return V({url:"/point-consumption-rule/query",method:"get",params:{packageId:p,functionId:f}})}const R={getAllRules:$e,getRuleById:Ae,createRule:De,updateRule:Fe,deleteRule:Te,getRuleByPackageAndFunction:Me},x=p=>(Re("data-v-a2597c9e"),p=p(),Ve(),p),je=x(()=>r("div",{class:"flex items-center gap-4"},"积分消耗设置",-1)),Ue=x(()=>r("div",{class:"text-sm/6"},[r("div",null,"积分消耗设置用于控制不同套餐在使用各种功能时消耗的积分点数。"),r("div",null,"设置消耗积分数量，设置为0则不消耗积分，大于0则按设定数量消耗。"),r("div",null,'选择"无套餐用户"可为未购买任何套餐的普通用户设置消耗规则。')],-1)),Be={class:"flex gap-2"},Se=x(()=>r("div",{slot:"header",class:"card-header"},[r("h3",null,"功能定义"),r("p",{class:"text-sm text-gray-500"},"定义系统功能并为其分配唯一标识，用于设置不同套餐的积分消耗规则")],-1)),qe=x(()=>r("div",{slot:"header",class:"card-header"},[r("h3",null,"消耗规则设置"),r("p",{class:"text-sm text-gray-500"},"为不同套餐的不同功能设置积分消耗规则，包括无套餐的普通用户")],-1)),Pe={class:"text-xs text-gray-500"},Oe={class:"text-xs text-gray-500"},ze={class:"text-xs text-gray-500"},Ee={class:"text-xs text-gray-500"},Je=x(()=>r("div",{class:"text-xs text-gray-500"},"最大可同时执行任务数",-1)),Le={class:"text-xs text-gray-500"},Ge=x(()=>r("div",{class:"text-xs text-gray-500 mt-1"}," 设置为0则不消耗积分，直接填写消耗的积分数量 ",-1)),He=x(()=>r("div",{class:"text-xs text-gray-500 mt-1"}," 设置为0则不消耗积分，直接填写消耗的积分数量 ",-1)),Ke=x(()=>r("div",{class:"text-xs text-gray-500 mt-1"}," 设置为0则不消耗积分，直接填写消耗的积分数量 ",-1)),We=x(()=>r("div",{class:"text-xs text-gray-500 mt-1"},"设置功能可同时执行的最大任务数量，对批量生成任务有效",-1)),Xe=x(()=>r("div",{class:"text-xs text-gray-500 mt-1"},'设置为"可用"表示该套餐可以使用此功能，设置为"不可用"表示该套餐无法使用此功能',-1)),Ye={class:"dialog-footer"},Ze=x(()=>r("div",{class:"text-xs text-gray-500 mt-1"}," 功能标识用于系统识别，只能使用字母、数字和下划线 ",-1)),Qe={class:"dialog-footer"},ne=be({__name:"pointConsumption",setup(p){const f=h([]),g=h([]),k=h(!1),N=h([]),O=h(),C=h(!1),T=h("新增积分消耗规则"),o=F({id:0,packageId:0,packageName:"",functionId:"",model3Rate:0,model4Rate:0,drawMjRate:0,status:1,isAvailable:1,maxConcurrentTasks:1}),M=h(),$=h(!1),u=F({id:0,functionId:"",functionName:"",description:""}),se=F({functionId:[{required:!0,message:"请输入功能标识",trigger:"blur"},{pattern:/^[a-zA-Z0-9_]+$/,message:"功能标识只能包含字母、数字和下划线",trigger:"blur"}],functionName:[{required:!0,message:"请输入功能名称",trigger:"blur"}]}),ie=F({packageId:[{required:!0,message:"请选择套餐",trigger:"change"}],functionId:[{required:!0,message:"请选择功能",trigger:"change"}],model3Rate:[{required:!0,message:"请输入普通积分消耗数量",trigger:"blur"},{type:"number",min:0,message:"积分数量必须大于等于0",trigger:"blur"}],model4Rate:[{required:!0,message:"请输入高级积分消耗数量",trigger:"blur"},{type:"number",min:0,message:"积分数量必须大于等于0",trigger:"blur"}],drawMjRate:[{required:!0,message:"请输入绘画积分消耗数量",trigger:"blur"},{type:"number",min:0,message:"积分数量必须大于等于0",trigger:"blur"}]}),re=async()=>{try{const a=await Ce.queryAllPackage({page:1,size:100,status:1});a.data&&a.data.rows&&(N.value=a.data.rows.map(e=>({id:e.id,name:e.name,price:e.price,weight:e.weight})))}catch(a){console.error("获取套餐列表失败:",a)}},ue=async()=>{try{const a=await oe.queryConfig({keys:["pointConsumptionFunctions"]});if(a.data&&a.data.pointConsumptionFunctions)try{g.value=JSON.parse(a.data.pointConsumptionFunctions)}catch{g.value=[]}else g.value=[]}catch(a){console.error("获取功能列表失败:",a),g.value=[]}},z=async()=>{try{await oe.setConfig({settings:de({pointConsumptionFunctions:JSON.stringify(g.value)})}),c.success("保存功能定义成功")}catch(a){console.error("保存功能定义失败:",a),c.error("保存功能定义失败")}};function de(a){return Object.keys(a).map(e=>({configKey:e,configVal:a[e]}))}const E=a=>{a?Object.assign(u,a):(u.id=Date.now(),u.functionId="",u.functionName="",u.description=""),$.value=!0},ce=a=>{ae.confirm(`确定要删除功能 "${a.functionName}" 吗?`,"警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{g.value=g.value.filter(i=>i.id!==a.id);const e=f.value.filter(i=>i.functionId===a.functionId);for(const i of e)try{await R.deleteRule(i.id)}catch(s){console.error("删除规则失败:",s)}f.value=f.value.filter(i=>i.functionId!==a.functionId),await z(),c.success("删除成功")}catch(e){console.error("删除功能失败:",e),c.error("删除功能失败")}}).catch(()=>{})},me=async()=>{M.value&&await M.value.validate(async a=>{if(a){if(g.value.some(s=>s.functionId===u.functionId&&s.id!==u.id)){c.error("功能标识已存在，请更换");return}const i=g.value.findIndex(s=>s.id===u.id);i>-1?g.value[i]={...u}:g.value.push({...u}),z(),$.value=!1,c.success("保存成功")}})},J=async()=>{k.value=!0;try{const a=await R.getAllRules();a.data&&a.data.data?(f.value=a.data.data,f.value.forEach(e=>{if(e.packageId===0)e.packageName="无套餐用户";else{const i=N.value.find(s=>s.id===e.packageId);i?e.packageName=i.name:e.packageName=`套餐ID: ${e.packageId}`}})):f.value=[]}catch(a){console.error("获取积分消耗规则失败:",a),c.error("获取积分消耗规则失败"),f.value=[]}finally{k.value=!1}},L=a=>{a?(T.value="编辑积分消耗规则",Object.assign(o,a)):(T.value="新增积分消耗规则",o.id=0,o.packageId=0,o.packageName="无套餐用户",o.functionId="",o.model3Rate=0,o.model4Rate=0,o.drawMjRate=0,o.status=1,o.isAvailable=1,o.maxConcurrentTasks=1),C.value=!0},G=a=>{const e=g.value.find(i=>i.functionId===a);return e?e.functionName:a},pe=async a=>{a&&await a.validate(async e=>{var i;if(e){k.value=!0;try{const s={packageId:Number(o.packageId),functionId:o.functionId,model3Rate:Number(o.model3Rate),model4Rate:Number(o.model4Rate),drawMjRate:Number(o.drawMjRate),status:Number(o.status),isAvailable:Number(o.isAvailable),maxConcurrentTasks:Number(o.maxConcurrentTasks)};if(o.description&&(s.description=o.description),o.packageId===0)s.packageName="无套餐用户";else{const m=N.value.find(w=>w.id===o.packageId);s.packageName=m?m.name:`套餐ID: ${o.packageId}`}o.id&&(s.id=o.id);let d;o.id?(console.log(`更新规则ID=${o.id}, 数据:`,JSON.stringify(s)),d=await R.updateRule(o.id,s)):(console.log("创建新规则数据:",JSON.stringify(s)),d=await R.createRule(s)),console.log("API响应:",d),d.data&&d.data.success?(c.success(o.id?"更新规则成功":"创建规则成功"),C.value=!1,J()):c.error(((i=d.data)==null?void 0:i.message)||"操作失败")}catch(s){console.error("保存规则失败:",s);let d="保存规则失败";s.response&&s.response.data?d+=": "+(s.response.data.message||s.response.data.error||"未知错误"):s.message&&(d+=": "+s.message),c.error(d)}finally{k.value=!1}}else c.error("请完善表单信息")})},fe=(a,e)=>{ae.confirm(`确定删除"${a.packageName}"的"${G(a.functionId)}"规则吗？`,"删除确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{var i;k.value=!0;try{console.log("删除规则ID:",a.id);const s=await R.deleteRule(a.id);console.log("删除响应:",s),s.data&&s.data.success?(c.success("删除成功"),f.value.splice(e,1)):c.error(((i=s.data)==null?void 0:i.message)||"删除失败")}catch(s){console.error("删除规则失败:",s),s.response&&(console.error("错误响应状态:",s.response.status),console.error("错误响应数据:",s.response.data)),c.error("删除规则失败: "+(s.message||"未知错误"))}finally{k.value=!1}}).catch(()=>{})},ge=async a=>{var e;k.value=!0;try{const i=a.isAvailable===1?0:1,s={id:a.id,isAvailable:i};console.log(`更新规则ID=${a.id}可用性为: ${i}`);const d=await R.updateRule(a.id,s);console.log("可用性更新响应:",d),d.data&&d.data.success?(c.success(`设置为${i===1?"可用":"不可用"}成功`),a.isAvailable=i):c.error(((e=d.data)==null?void 0:e.message)||"操作失败")}catch(i){console.error("更新功能可用性失败:",i);let s="操作失败";i.response&&i.response.data?s+=": "+(i.response.data.message||i.response.data.error||"未知错误"):i.message&&(s+=": "+i.message),c.error(s)}finally{k.value=!1}},ve=a=>{if(a===0)o.packageName="无套餐用户";else{const e=N.value.find(i=>i.id===a);e?o.packageName=e.name:o.packageName=`套餐ID: ${a}`,console.log(`套餐ID ${a} 设置名称为: ${o.packageName}`)}};return xe(()=>{re(),ue(),J()}),(a,e)=>{const i=he,s=Ie,d=ye,m=_("el-table-column"),w=_("el-button"),H=_("el-table"),K=_("el-card"),W=_("el-tag"),j=_("el-option"),X=_("el-select"),b=_("el-form-item"),A=_("el-input-number"),Y=_("el-switch"),Z=_("el-form"),Q=_("el-dialog"),U=_("el-input"),_e=we("loading");return I(),B("div",null,[l(d,null,{title:n(()=>[je]),content:n(()=>[Ue]),default:n(()=>[r("div",Be,[l(s,{outline:"",onClick:e[0]||(e[0]=t=>E())},{default:n(()=>[l(i,{name:"i-carbon:function"}),y(" 添加功能 ")]),_:1}),l(s,{outline:"",onClick:e[1]||(e[1]=t=>L())},{default:n(()=>[l(i,{name:"i-carbon:add"}),y(" 添加消耗规则 ")]),_:1})])]),_:1}),l(K,{style:{margin:"20px 20px 10px 20px"}},{default:n(()=>[Se,l(H,{data:g.value,style:{width:"100%"},border:""},{default:n(()=>[l(m,{prop:"functionId",label:"功能标识",width:"180"}),l(m,{prop:"functionName",label:"功能名称",width:"180"}),l(m,{prop:"description",label:"功能描述"}),l(m,{label:"操作",width:"150"},{default:n(t=>[l(w,{type:"primary",size:"small",onClick:D=>E(t.row)},{default:n(()=>[y(" 编辑 ")]),_:2},1032,["onClick"]),l(w,{type:"danger",size:"small",onClick:D=>ce(t.row)},{default:n(()=>[y(" 删除 ")]),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])]),_:1}),l(K,{style:{margin:"10px 20px 20px 20px"}},{default:n(()=>[qe,ke((I(),S(H,{data:f.value,style:{width:"100%"},border:""},{default:n(()=>[l(m,{prop:"packageName",label:"套餐名称",width:"150"},{default:n(t=>[r("div",null,v(t.row.packageId===0?"无套餐用户":t.row.packageName||`套餐ID: ${t.row.packageId}`),1)]),_:1}),l(m,{label:"功能",width:"150"},{default:n(t=>[r("div",null,v(G(t.row.functionId)),1),r("div",Pe,v(t.row.functionId),1)]),_:1}),l(m,{label:"普通积分消耗",width:"150"},{default:n(t=>[r("div",null,v(t.row.model3Rate),1),r("div",Oe,v(q(P)[0].label),1)]),_:1}),l(m,{label:"高级积分消耗",width:"150"},{default:n(t=>[r("div",null,v(t.row.model4Rate),1),r("div",ze,v(q(P)[1].label),1)]),_:1}),l(m,{label:"绘画积分消耗",width:"150"},{default:n(t=>[r("div",null,v(t.row.drawMjRate),1),r("div",Ee,v(q(P)[2].label),1)]),_:1}),l(m,{label:"最大并发数",width:"120"},{default:n(t=>[r("div",null,v(t.row.maxConcurrentTasks||1),1),Je]),_:1}),l(m,{prop:"status",label:"状态",width:"100"},{default:n(t=>[l(W,{type:t.row.status===1?"success":"danger"},{default:n(()=>[y(v(t.row.status===1?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1}),l(m,{prop:"isAvailable",label:"是否可用",width:"100"},{default:n(t=>[l(W,{type:t.row.isAvailable===1?"success":"danger",onClick:D=>ge(t.row),style:{cursor:"pointer"}},{default:n(()=>[y(v(t.row.isAvailable===1?"可用":"不可用"),1)]),_:2},1032,["type","onClick"])]),_:1}),l(m,{label:"操作",width:"150"},{default:n(t=>[l(w,{type:"primary",size:"small",onClick:D=>L(t.row)},{default:n(()=>[y(" 编辑 ")]),_:2},1032,["onClick"]),l(w,{type:"danger",size:"small",onClick:D=>fe(t.row,t.$index)},{default:n(()=>[y(" 删除 ")]),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[_e,k.value]])]),_:1}),l(Q,{modelValue:C.value,"onUpdate:modelValue":e[12]||(e[12]=t=>C.value=t),title:T.value,width:"600px"},{footer:n(()=>[r("span",Ye,[l(w,{onClick:e[10]||(e[10]=t=>C.value=!1)},{default:n(()=>[y("取消")]),_:1}),l(w,{type:"primary",onClick:e[11]||(e[11]=t=>pe(O.value))},{default:n(()=>[y(" 确定 ")]),_:1})])]),default:n(()=>[l(Z,{ref_key:"formRef",ref:O,model:o,rules:ie,"label-width":"120px"},{default:n(()=>[l(b,{label:"套餐",prop:"packageId"},{default:n(()=>[l(X,{modelValue:o.packageId,"onUpdate:modelValue":e[2]||(e[2]=t=>o.packageId=t),placeholder:"请选择套餐",style:{width:"100%"},onChange:ve},{default:n(()=>[l(j,{key:"0",label:"无套餐用户",value:0}),(I(!0),B(ee,null,te(N.value,t=>(I(),S(j,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),l(b,{label:"功能",prop:"functionId"},{default:n(()=>[l(X,{modelValue:o.functionId,"onUpdate:modelValue":e[3]||(e[3]=t=>o.functionId=t),placeholder:"请选择功能",style:{width:"100%"}},{default:n(()=>[(I(!0),B(ee,null,te(g.value,t=>(I(),S(j,{key:t.functionId,label:t.functionName,value:t.functionId},{default:n(()=>[r("div",null,v(t.functionName),1),r("div",Le,v(t.functionId),1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),l(b,{label:"普通积分消耗",prop:"model3Rate"},{default:n(()=>[l(A,{modelValue:o.model3Rate,"onUpdate:modelValue":e[4]||(e[4]=t=>o.model3Rate=t),min:0,step:1,style:{width:"100%"}},null,8,["modelValue"]),Ge]),_:1}),l(b,{label:"高级积分消耗",prop:"model4Rate"},{default:n(()=>[l(A,{modelValue:o.model4Rate,"onUpdate:modelValue":e[5]||(e[5]=t=>o.model4Rate=t),min:0,step:1,style:{width:"100%"}},null,8,["modelValue"]),He]),_:1}),l(b,{label:"绘画积分消耗",prop:"drawMjRate"},{default:n(()=>[l(A,{modelValue:o.drawMjRate,"onUpdate:modelValue":e[6]||(e[6]=t=>o.drawMjRate=t),min:0,step:1,style:{width:"100%"}},null,8,["modelValue"]),Ke]),_:1}),l(b,{label:"最大并发任务数",prop:"maxConcurrentTasks"},{default:n(()=>[l(A,{modelValue:o.maxConcurrentTasks,"onUpdate:modelValue":e[7]||(e[7]=t=>o.maxConcurrentTasks=t),min:1,max:10,placeholder:"请输入最大并发任务数",style:{width:"100%"}},null,8,["modelValue"]),We]),_:1}),l(b,{label:"状态",prop:"status"},{default:n(()=>[l(Y,{modelValue:o.status,"onUpdate:modelValue":e[8]||(e[8]=t=>o.status=t),"active-value":1,"inactive-value":0,"active-text":"启用","inactive-text":"禁用"},null,8,["modelValue"])]),_:1}),l(b,{label:"是否可用",prop:"isAvailable"},{default:n(()=>[l(Y,{modelValue:o.isAvailable,"onUpdate:modelValue":e[9]||(e[9]=t=>o.isAvailable=t),"active-value":1,"inactive-value":0,"active-text":"可用","inactive-text":"不可用"},null,8,["modelValue"]),Xe]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["modelValue","title"]),l(Q,{modelValue:$.value,"onUpdate:modelValue":e[17]||(e[17]=t=>$.value=t),title:"功能定义",width:"600px"},{footer:n(()=>[r("span",Qe,[l(w,{onClick:e[16]||(e[16]=t=>$.value=!1)},{default:n(()=>[y("取消")]),_:1}),l(w,{type:"primary",onClick:me},{default:n(()=>[y(" 确定 ")]),_:1})])]),default:n(()=>[l(Z,{ref_key:"functionFormRef",ref:M,model:u,rules:se,"label-width":"120px"},{default:n(()=>[l(b,{label:"功能标识",prop:"functionId"},{default:n(()=>[l(U,{modelValue:u.functionId,"onUpdate:modelValue":e[13]||(e[13]=t=>u.functionId=t),placeholder:"请输入唯一的功能标识，如: chat_gpt4, draw_midjourney"},null,8,["modelValue"]),Ze]),_:1}),l(b,{label:"功能名称",prop:"functionName"},{default:n(()=>[l(U,{modelValue:u.functionName,"onUpdate:modelValue":e[14]||(e[14]=t=>u.functionName=t),placeholder:"请输入功能名称，如: GPT-4聊天, MidJourney绘画"},null,8,["modelValue"])]),_:1}),l(b,{label:"功能描述",prop:"description"},{default:n(()=>[l(U,{modelValue:u.description,"onUpdate:modelValue":e[15]||(e[15]=t=>u.description=t),type:"textarea",rows:3,placeholder:"请输入功能描述信息"},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["modelValue"])])}}});typeof le=="function"&&le(ne);const nt=Ne(ne,[["__scopeId","data-v-a2597c9e"]]);export{nt as default};
